# Adapted Build & Publish Quarto Book workflow that uses renv.
# - Restores packages from renv.lock when present (recommended).
# - Optionally snapshots and commits an updated renv.lock back to the repo if you set UPDATE_RENV_LOCK=true.
# - Caches renv artifacts to speed up runs.
# - Adjust R/Quarto versions and the book path (_book) as needed.
#
# Usage notes:
# - Recommended: keep renv.lock in repo and let CI run renv::restore() before rendering.
# - If you want CI to produce a new renv.lock and push it back, set repo secret UPDATE_RENV_LOCK=true (or set an environment variable in a manual dispatch).
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  R_LIBS_USER: ${{ runner.temp }}/R_libs

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed if we will update renv.lock and push

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev fonts-dejavu-core

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          quarto-version: 'latest'

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
          # r-version: '4.3' # uncomment and pin if you want a specific R version

      - name: Cache renv (library & cache)
        uses: actions/cache@v4
        id: cache-renv
        with:
          path: |
            renv/library
            renv/cache
            ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}

      - name: Ensure renv is available
        run: |
          Rscript -e "if (!requireNamespace('renv', quietly = TRUE)) install.packages('renv', repos='https://cloud.r-project.org')"

      - name: Restore or Snapshot renv
        # If renv.lock exists -> restore (recommended). Otherwise create a snapshot.
        run: |
          if [ -f renv.lock ]; then
            echo "renv.lock found — restoring project library"
            Rscript -e "renv::restore(prompt = FALSE)"
          else
            echo "No renv.lock found — creating a lock with renv::snapshot()"
            # snapshot will write renv.lock in repo workspace
            Rscript -e "renv::snapshot(prompt = FALSE)"
          fi


      - name: Quarto check (nonblocking)
        run: |
          quarto check || true

      - name: Render Quarto book
        run: |
          # If your book root is a subdirectory, add working-directory: path/to/book to this step
          quarto render --no-cache
        # Do not force RENV_CONFIG_ACTIVE=FALSE: we want renv activation to use the restored project library.
        # If you have a specific reason to disable activation, add env: RENV_CONFIG_ACTIVE: FALSE

      - name: Verify output and list files
        run: |
          for d in _site _book docs public; do
            if [ -d "$d" ]; then
              echo "---- $d ----"
              find "$d" -maxdepth 2 -type f | sed -n '1,200p'
            fi
          done

      - name: Publish _book to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          publish_branch: gh-pages
          publish_dir: ./_book
          github_token: ${{ secrets.GITHUB_TOKEN }}
