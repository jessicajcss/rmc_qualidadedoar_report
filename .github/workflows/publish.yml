# Robust Quarto book workflow using renv and caching; publishes with GH.TOKEN secret
name: Build and Publish Quarto Book (renv)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: quarto-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup R (with RSPM)
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install apt packages (system deps)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev libssl-dev libxml2-dev \
            libcairo2-dev libpango1.0-dev libpng-dev \
            fonts-dejavu-core libgomp1
        shell: bash

      - name: Configure renv cache paths
        run: |
          # define a cache path inside runner temp (cacheable)
          echo "RENV_PATHS_CACHE=${RUNNER_TEMP}/renv-cache" >> $GITHUB_ENV
          mkdir -p "${RUNNER_TEMP}/renv-cache"
          # define project library path (where renv will install packages for this project)
          echo "RENV_PROJECT_LIBRARY=${RUNNER_TEMP}/renv-library" >> $GITHUB_ENV
          mkdir -p "${RUNNER_TEMP}/renv-library"
        shell: bash

      - name: Restore renv caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.RENV_PATHS_CACHE }}
            ${{ env.RENV_PROJECT_LIBRARY }}
          key: renv-${{ runner.os }}-${{ hashFiles('renv.lock') }}
          restore-keys: |
            renv-${{ runner.os }}-

      - name: Ensure renv is installed
        run: |
          Rscript -e "if (!requireNamespace('renv', quietly=TRUE)) install.packages('renv', repos='https://cloud.r-project.org')"
        env:
          R_LIBS_USER: ${{ env.RENV_PROJECT_LIBRARY }}

      - name: Restore R packages from renv.lock
        run: |
          # use the project renv: put project's library first
          export R_LIBS_USER="${RENV_PROJECT_LIBRARY}:${R_LIBS_USER:-}"
          Rscript -e "options(repos='https://cloud.r-project.org'); renv::restore(lockfile = 'renv.lock', prompt = FALSE)"
        env:
          R_LIBS_USER: ${{ env.RENV_PROJECT_LIBRARY }}

      - name: Save renv caches
        if: success()
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.RENV_PATHS_CACHE }}
            ${{ env.RENV_PROJECT_LIBRARY }}
          key: renv-${{ runner.os }}-${{ hashFiles('renv.lock') }}

      - name: Check data/processed (diagnostic)
        run: |
          if [ -d data/processed ]; then ls -la data/processed || true; else echo "data/processed missing"; fi
        shell: bash

      - name: Render Quarto book (capture logs)
        run: |
          set -o pipefail
          mkdir -p build_logs
          quarto render --no-cache 2>&1 | tee build_logs/quarto_render.log
        env:
          RENV_CONFIG_ACTIVE: FALSE
          R_PROFILE_USER: ${{ github.workspace }}/.Rprofile

      - name: Upload render logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quarto-render-logs
          path: build_logs

      - name: Upload built book artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-book
          path: _book
          retention-days: 7

      - name: Publish to gh-pages
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          publish_branch: gh-pages
          publish_dir: ./_book
          # use your PAT secret name GH.TOKEN
          github_token: ${{ secrets.GH.TOKEN }}
