---
title: "Padrões Temporais da Qualidade do Ar"
---

```{r}
library(dplyr)
library(ggplot2)
library(lubridate)
library(ggh4x)
library(reshape2)
source("scripts/load_cached_data.R")

```

### Padrão hora × dia da semana (GM-5000 horário)

```{r}
if (exists("air_quality_data_ugm3")) {
  gm_hour <- air_quality_data_ugm3 %>%
    mutate(hr = hour(date),
           wday = lubridate::wday(date, label = TRUE)) %>%
    tidyr::pivot_longer(-c(Cidade,date,hr,wday), names_to="Poluente", values_to="Valor") %>%
    group_by(Cidade, Poluente, wday, hr) %>%
    summarise(Media = mean(Valor, na.rm=TRUE), .groups="drop")

  ggplot(gm_hour, aes(hr, Media, colour=wday)) +
    geom_line(linewidth=0.4) +
    ggh4x::facet_nested(Poluente ~ Cidade, scales="free_y") +
    scale_x_continuous(breaks=seq(0,24,4)) +
    theme_classic() +
    labs(x="Hora", y="Média horária", colour="Dia", title="Padrões hora × dia da semana (GM-5000)")
}
```

### Padrão hora × dia da semana (PurpleAir)

```{r}
if (exists("purpleair")) {
  pa_hour <- purpleair %>%
    mutate(hr = hour(Date),
           wday = lubridate::wday(Date, label = TRUE)) %>%
    group_by(Cidade, sensor_id, wday, hr) %>%
    summarise(PM25 = mean(PM2.5, na.rm=TRUE), .groups="drop")

  ggplot(pa_hour, aes(hr, PM25, colour=wday)) +
    geom_line(linewidth=0.4) +
    ggh4x::facet_nested(. ~ Cidade + sensor_id, scales="free_y") +
    scale_x_continuous(breaks=seq(0,24,4)) +
    theme_classic() +
    labs(x="Hora", y="PM2.5 (µg/m³)", colour="Dia", title="Padrões hora × dia da semana (PurpleAir)")
}
```

### Comparação com Limites OMS (diário GM-5000)

```{r}
if (exists("Datafinal")) {
  df_day <- Datafinal %>%
    select(Cidade, Date, SO2, NO2, PM2.5, PM10, O3, CO) %>%
    tidyr::pivot_longer(-c(Cidade, Date), names_to="Poluente", values_to="Valor")

  df_mean <- df_day %>%
    group_by(Cidade, Poluente) %>%
    summarise(Media = mean(Valor, na.rm=TRUE), .groups="drop")

  ggplot(df_day, aes(Date, Valor)) +
    stat_summary(fun="mean", geom="col", fill="grey70") +
    geom_hline(data=df_mean, aes(yintercept=Media, linetype="média período"), colour="black") +
    facet_wrap(~Poluente, scales="free_y") +
    scale_x_date(breaks="1 month", labels=scales::label_date_short()) +
    theme_bw() +
    labs(x="Data", y="Concentração", linetype="", title="Médias diárias por poluente") +
    theme(legend.position="bottom")
}
```
